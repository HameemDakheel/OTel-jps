# =============================================================================
# Deploy to Jelastic on Push
# =============================================================================
# Automatically deploys configuration changes to your Jelastic environment
#
# Prerequisites - Add these secrets to your GitHub repository:
#   - JELASTIC_URL: Your provider URL (e.g., "https://app.hidora.com")
#   - JELASTIC_USERNAME: Your Jelastic login email
#   - JELASTIC_TOKEN: Your Jelastic password or API token
#   - JELASTIC_ENV_NAME: Your environment name (e.g., "observability")
# =============================================================================

name: Deploy to Jelastic

on:
  push:
    branches: [ "main" ]
    paths:
      - 'configs/**'
      - 'docker-compose.yml'
      - 'manifest.jps'
  workflow_dispatch:  # Allow manual triggering

env:
  STACK_PATH: /opt/observability

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Docker Compose
        run: |
          docker compose config --quiet
          echo "✅ docker-compose.yml is valid"

      - name: Validate YAML configs
        run: |
          for file in configs/*.yaml configs/**/*.yaml configs/**/*.yml; do
            if [ -f "$file" ]; then
              python3 -c "import yaml; yaml.safe_load(open('$file'))"
              echo "✅ $file is valid"
            fi
          done

      - name: Validate JPS manifest
        run: |
          python3 -c "import json; json.load(open('manifest.jps'))"
          echo "✅ manifest.jps is valid"

  deploy:
    name: Deploy to Jelastic
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pull latest code on Jelastic
        uses: DovnarAlexander/github-actions-jelastic@master
        with:
          jelastic_url: ${{ secrets.JELASTIC_URL }}
          jelastic_username: ${{ secrets.JELASTIC_USERNAME }}
          jelastic_password: ${{ secrets.JELASTIC_TOKEN }}
          task: environment/control/execCmdByGroup --envName ${{ secrets.JELASTIC_ENV_NAME }} --nodeGroup cp --commandList "[{\"command\":\"cd /opt/observability && git pull origin main\"}]"

      - name: Restart Docker Compose stack
        uses: DovnarAlexander/github-actions-jelastic@master
        with:
          jelastic_url: ${{ secrets.JELASTIC_URL }}
          jelastic_username: ${{ secrets.JELASTIC_USERNAME }}
          jelastic_password: ${{ secrets.JELASTIC_TOKEN }}
          task: environment/control/execCmdByGroup --envName ${{ secrets.JELASTIC_ENV_NAME }} --nodeGroup cp --commandList "[{\"command\":\"cd /opt/observability && docker compose pull && docker compose up -d --remove-orphans\"}]"

      - name: Health check
        uses: DovnarAlexander/github-actions-jelastic@master
        with:
          jelastic_url: ${{ secrets.JELASTIC_URL }}
          jelastic_username: ${{ secrets.JELASTIC_USERNAME }}
          jelastic_password: ${{ secrets.JELASTIC_TOKEN }}
          task: environment/control/execCmdByGroup --envName ${{ secrets.JELASTIC_ENV_NAME }} --nodeGroup cp --commandList "[{\"command\":\"sleep 30 && docker compose -f /opt/observability/docker-compose.yml ps\"}]"
