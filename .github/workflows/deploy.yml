# =============================================================================
# Deploy to Jelastic on Push
# =============================================================================
# Automatically deploys configuration changes to your Jelastic environment
# Uses direct Jelastic REST API calls (no third-party actions)
#
# Prerequisites - Add these secrets to your GitHub repository:
#   - JELASTIC_URL: Your provider URL (e.g., "app.hidora.com") - without https://
#   - JELASTIC_TOKEN: Your Jelastic session token or API key
#   - JELASTIC_ENV_NAME: Your environment name (e.g., "observability")
# =============================================================================

name: Deploy to Jelastic

on:
  push:
    branches: [ "main" ]
    paths:
      - 'configs/**'
      - 'docker-compose.yml'
      - 'manifest.jps'
  workflow_dispatch:  # Allow manual triggering

env:
  STACK_PATH: /opt/observability

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Docker Compose
        run: |
          docker compose config --quiet
          echo "✅ docker-compose.yml is valid"

      - name: Validate YAML configs
        run: |
          for file in configs/*.yaml configs/**/*.yaml configs/**/*.yml; do
            if [ -f "$file" ]; then
              python3 -c "import yaml; yaml.safe_load(open('$file'))"
              echo "✅ $file is valid"
            fi
          done

      - name: Validate JPS manifest
        run: |
          python3 -c "import json; json.load(open('manifest.jps'))"
          echo "✅ manifest.jps is valid"

  deploy:
    name: Deploy to Jelastic
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pull latest code on Jelastic
        run: |
          RESPONSE=$(curl -s -X POST "https://${{ secrets.JELASTIC_URL }}/1.0/environment/control/rest/execCmdByGroup" \
            -d "envName=${{ secrets.JELASTIC_ENV_NAME }}" \
            -d "session=${{ secrets.JELASTIC_TOKEN }}" \
            -d "nodeGroup=cp" \
            -d 'commandList=[{"command":"cd /opt/observability && git pull origin main"}]')
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q '"result":0'; then
            echo "✅ Git pull successful"
          else
            echo "❌ Git pull failed"
            exit 1
          fi

      - name: Restart Docker Compose stack
        run: |
          RESPONSE=$(curl -s -X POST "https://${{ secrets.JELASTIC_URL }}/1.0/environment/control/rest/execCmdByGroup" \
            -d "envName=${{ secrets.JELASTIC_ENV_NAME }}" \
            -d "session=${{ secrets.JELASTIC_TOKEN }}" \
            -d "nodeGroup=cp" \
            -d 'commandList=[{"command":"cd /opt/observability && docker compose pull && docker compose up -d --remove-orphans"}]')
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q '"result":0'; then
            echo "✅ Docker Compose restart successful"
          else
            echo "❌ Docker Compose restart failed"
            exit 1
          fi

      - name: Wait for services
        run: sleep 30

      - name: Health check
        run: |
          RESPONSE=$(curl -s -X POST "https://${{ secrets.JELASTIC_URL }}/1.0/environment/control/rest/execCmdByGroup" \
            -d "envName=${{ secrets.JELASTIC_ENV_NAME }}" \
            -d "session=${{ secrets.JELASTIC_TOKEN }}" \
            -d "nodeGroup=cp" \
            -d 'commandList=[{"command":"docker compose -f /opt/observability/docker-compose.yml ps"}]')
          echo "Response: $RESPONSE"
          echo "✅ Deployment complete!"
