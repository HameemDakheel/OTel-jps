# /etc/nginx/conf.d/observability.conf

# -----------------------------------------------------------------------------
# Upstreams pointing to Docker Swarm Nodes
# Replace SWARM_NODE_PRIVATE_IP with the actual IP (e.g., 10.x.x.x)
# -----------------------------------------------------------------------------
upstream grafana_backend {
    server 10.6.4.132:3000;
    keepalive 32;
}

upstream jaeger_backend {
    server 10.6.4.132:16686;
    keepalive 32;
}

upstream prometheus_backend {
    server 10.6.4.132:9090;
    keepalive 32;
}

upstream otel_http_backend {
    server 10.6.4.132:4318;
    keepalive 32;
}

# -----------------------------------------------------------------------------
# HTTPS Server Block
# This will coexist with the default HTTP server in the main config.
# -----------------------------------------------------------------------------
server {
    listen 443 ssl http2;
    # IMPORTANT: Set your actual domain here to avoid conflicts
    server_name env-2333722.fin.libyanspider.cloud;

    # SSL Configuration
    # Ensure these paths are correct on your upstream node
    ssl_certificate /var/lib/jelastic/keys/fullchain.pem;
    ssl_certificate_key /var/lib/jelastic/keys/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # -------------------------------------------------------------------------
    # Proxy Rules
    # -------------------------------------------------------------------------

    # 1. Grafana (at /grafana/)
    location /grafana/ {
        proxy_pass http://grafana_backend/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 2. Jaeger UI (at /jaeger/)
    location /jaeger/ {
        proxy_pass http://jaeger_backend/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 3. Prometheus UI (at /prometheus/)
    location /prometheus/ {
        proxy_pass http://prometheus_backend/prometheus/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 4. OTLP HTTP (at /v1/)
    location /v1/ {
        proxy_pass http://otel_http_backend/v1/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 5. Root Redirect
    location = / {
        return 301 /grafana/;
    }
}
